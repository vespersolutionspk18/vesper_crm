import{_ as Ie,a as Ve,L as ze}from"./SidePanelModal-7abc63d3.js";import{A as $e,a as De,S as Se,b as Ue,L as Ae}from"./SLASection-60be6e93.js";import{E as Ee}from"./EditIcon-5c615a04.js";import{E as O}from"./EmailIcon-5d882006.js";import{C as Me}from"./CommentIcon-8a1c544e.js";import{P}from"./PhoneIcon-2b0b9034.js";import{T as Ne}from"./TaskIcon-ba34b83b.js";import{N as Be}from"./NoteModal-67a2219e.js";import{W as Re}from"./WhatsAppIcon-a922c570.js";import{I as Te}from"./IndicatorIcon-8bdc1dd8.js";import{A as Le}from"./ArrowUpRightIcon-4de3e6ce.js";import{S as Fe}from"./Fields-bccd83f4.js";import{_ as Oe,a as Pe}from"./LayoutHeader-f400e0a9.js";import{_ as je}from"./OrganizationModal-7c7ff91b.js";import{_ as qe}from"./AssignmentModal-b9aa1b53.js";import{s as We,_ as Ge}from"./statuses-c18f787a.js";import{C as He}from"./ContactModal-7ee44134.js";import{_ as Ke}from"./Link-b1fdcf99.js";import{_ as Z}from"./Section-e7f6a7fa.js";import{_ as Je}from"./CustomActions-dd6491ed.js";import{c as Qe,e as Xe,g as b,h as Ye,i as M,o as Ze}from"./index-23e032df.js";import{g as ea,_ as z,b as ee}from"./global-005ed632.js";import{o as aa}from"./organizations-345b05ec.js";import{q as ta,v as oa,x as N,a as sa,k as y,i as j,r as q,b as m,c as p,u as t,g,w as r,l as _,d as o,F as W,I as $,G as la,n as B,K as na,e as u,t as x,f as ae,H as te,B as ia}from"./index-9a3d44ca.js";import{c as oe,w as ra}from"./settings-5e848745.js";import{D as se}from"./Dropdown-d1bc143c.js";import{_ as da}from"./Tabs-9ce471e9.js";import"./DragVerticalIcon-21aa16a4.js";import"./FadedScrollableDiv-3ad27946.js";import"./FileUploader-e02978ad.js";import"./DurationIcon-31a1b254.js";import"./CalendarIcon-e7721136.js";import"./LeadsIcon-6f6c2324.js";import"./DealsIcon-3bb51480.js";import"./EmailTemplateModal-8f279830.js";import"./TaskModal-74495bbe.js";import"./contacts-111adff3.js";import"./NestedPopover-767b5999.js";import"./OrganizationsIcon-f5eb7efc.js";const ma={key:1,class:"flex h-full overflow-hidden"},ua={class:"flex items-center justify-start gap-5 border-b p-5"},ca={class:"group relative size-12"},pa={class:"flex flex-col gap-2.5 truncate"},_a={class:"truncate text-2xl font-medium"},fa={class:"flex gap-1.5"},ga={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},va={class:"flex flex-col overflow-y-auto"},ya={key:0,class:"pr-2"},ba={key:1},xa={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-gray-500"},ha={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-gray-700"},Ca=["onClick"],ka={class:"truncate"},wa={class:"flex items-center"},Ia={class:"flex flex-col gap-1.5 text-base text-gray-800"},Va={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},za={class:"flex items-center gap-3 p-1 py-1.5"},$a={key:0,class:"mx-2 h-px border-t border-gray-200"},Da={key:2,class:"flex h-20 items-center justify-center text-base text-gray-600"},ft={__name:"Deal",props:{dealId:{type:String,required:!0}},setup(le){const{$dialog:ne,makeCall:ie}=ea(),{organizations:re,getOrganization:de}=aa(),{statusOptions:me,getDealStatus:ue}=We(),{isManager:ce}=ta(),D=oa(),f=le,s=N({url:"crm.fcrm.doctype.crm_deal.api.get_deal",params:{name:f.dealId},cache:["deal",f.dealId],onSuccess:a=>{Qe(a),Xe(a,{doc:a,$dialog:ne,router:D,updateField:I,createToast:b,deleteDoc:Ce,call:$})}});sa(()=>{s.data||s.fetch()});const R=y(!1),T=y(!1),S=y(!1),U=y(!1),L=y({}),w=j(()=>{var a;return((a=s.data)==null?void 0:a.organization)&&de(s.data.organization)});function pe(a,e,d){e=Array.isArray(a)?"":e,!_e(a,e)&&N({url:"frappe.client.set_value",params:{doctype:"CRM Deal",name:f.dealId,fieldname:a,value:e},auto:!0,onSuccess:()=>{s.reload(),R.value=!0,b({title:__("Deal updated"),icon:"check",iconClasses:"text-green-600"}),d==null||d()},onError:n=>{var C;b({title:__("Error updating deal"),text:__((C=n.messages)==null?void 0:C[0]),icon:"x",iconClasses:"text-red-600"})}})}function _e(a,e){var n;let d=s.data.fields_meta||{};return(n=d[a])!=null&&n.reqd&&!e?(b({title:__("Error Updating Deal"),text:__("{0} is a required field",[d[a].label]),icon:"x",iconClasses:"text-red-600"}),!0):!1}const fe=j(()=>{var e;let a=[{label:__("Deals"),route:{name:"Deals"}}];return a.push({label:((e=w.value)==null?void 0:e.name)||__("Untitled"),route:{name:"Deal",params:{dealId:s.data.name}}}),a}),A=y(0),ge=j(()=>[{name:"Activity",label:__("Activity"),icon:$e},{name:"Emails",label:__("Emails"),icon:O},{name:"Comments",label:__("Comments"),icon:Me},{name:"Calls",label:__("Calls"),icon:P,condition:()=>oe.value},{name:"Tasks",label:__("Tasks"),icon:Ne},{name:"Notes",label:__("Notes"),icon:Be},{name:"WhatsApp",label:__("WhatsApp"),icon:Re,condition:()=>ra.value}].filter(e=>e.condition?e.condition():!0)),E=N({url:"crm.api.doc.get_sidebar_fields",cache:["fieldsLayout",f.dealId],params:{doctype:"CRM Deal",name:f.dealId},auto:!0,transform:a=>ve(a)});function ve(a){return a.forEach(e=>{e.name!="contacts_section"&&e.fields.forEach(d=>{d.name=="organization"&&(d.create=(n,C)=>{L.value.organization_name=n,T.value=!0,C()},d.link=n=>D.push({name:"Organization",params:{organizationId:n}}))})}),a}const F=y(!1),G=y({});function ye(a){let e=[{label:__("Delete"),icon:"trash-2",onClick:()=>be(a)}];return a.is_primary||e.push({label:__("Set as Primary Contact"),icon:ia(Fe,{class:"h-4 w-4"}),onClick:()=>xe(a)}),e}async function H(a){await $("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:f.dealId,contact:a})&&(h.reload(),b({title:__("Contact added"),icon:"check",iconClasses:"text-green-600"}))}async function be(a){await $("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:f.dealId,contact:a})&&(h.reload(),b({title:__("Contact removed"),icon:"check",iconClasses:"text-green-600"}))}async function xe(a){await $("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:f.dealId,contact:a})&&(h.reload(),b({title:__("Primary contact set"),icon:"check",iconClasses:"text-green-600"}))}const h=N({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:f.dealId},cache:["deal_contacts",f.dealId],auto:!0,onSuccess:a=>{var d;let e=(d=E.data)==null?void 0:d.find(n=>n.name=="contacts_section");e&&(e.contacts=a.map(n=>({name:n.name,full_name:n.full_name,email:n.email,mobile_no:n.mobile_no,image:n.image,is_primary:n.is_primary,opened:!1})))}});function he(){var d;let a=(d=h.data)==null?void 0:d.find(n=>n.is_primary),e=a.mobile_no||null;if(!a){M(__("No primary contact set"));return}if(!e){M(__("No mobile number set"));return}ie(e)}function I(a,e,d){pe(a,e,()=>{s.data[a]=e,d==null||d()})}async function Ce(a){await $("frappe.client.delete",{doctype:"CRM Deal",name:a}),D.push({name:"Deals"})}const K=y(null);function ke(){K.value.emailBox.show=!0}return(a,e)=>{const d=q("FeatherIcon"),n=q("Button"),C=q("Badge");return m(),p(W,null,[t(s).data?(m(),g(Oe,{key:0},{"left-header":r(()=>[o(t(Pe),{items:fe.value},null,8,["items"])]),"right-header":r(()=>{var i;return[t(s).data._customActions?(m(),g(Je,{key:0,actions:t(s).data._customActions},null,8,["actions"])):_("",!0),(m(),g(la(((i=t(s).data._assignedTo)==null?void 0:i.length)==1?"Button":"div"),null,{default:r(()=>[o(Ge,{avatars:t(s).data._assignedTo,onClick:e[0]||(e[0]=l=>S.value=!0)},null,8,["avatars"])]),_:1})),o(t(se),{options:t(me)("deal",I)},{default:r(({open:l})=>[o(n,{label:t(s).data.status,class:B(t(ue)(t(s).data.status).colorClass)},{prefix:r(()=>[o(Te)]),suffix:r(()=>[o(d,{name:l?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label","class"])]),_:1},8,["options"])]}),_:1})):_("",!0),t(s).data?(m(),p("div",ma,[o(t(da),{modelValue:A.value,"onUpdate:modelValue":e[4]||(e[4]=i=>A.value=i),tabs:ge.value},{default:r(({tab:i})=>[o(De,{ref_key:"activities",ref:K,doctype:"CRM Deal",title:i.name,reload:R.value,"onUpdate:reload":e[1]||(e[1]=l=>R.value=l),tabIndex:A.value,"onUpdate:tabIndex":e[2]||(e[2]=l=>A.value=l),modelValue:t(s),"onUpdate:modelValue":e[3]||(e[3]=l=>na(s)?s.value=l:null)},null,8,["title","reload","tabIndex","modelValue"])]),_:1},8,["modelValue","tabs"]),o(Ie,{side:"right",class:"flex flex-col justify-between border-l"},{default:r(()=>{var i;return[u("div",{class:"flex h-10.5 cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium",onClick:e[5]||(e[5]=l=>t(Ye)(t(s).data.name))},x(a.__(t(s).data.name)),1),u("div",ua,[o(t(z),{text:a.__("Organization logo")},{default:r(()=>{var l,k;return[u("div",ca,[o(t(ee),{size:"3xl",class:"size-12",label:((l=w.value)==null?void 0:l.name)||a.__("Untitled"),image:(k=w.value)==null?void 0:k.organization_logo},null,8,["label","image"])])]}),_:1},8,["text"]),u("div",pa,[o(t(z),{text:((i=w.value)==null?void 0:i.name)||a.__("Set an organization")},{default:r(()=>{var l;return[u("div",_a,x(((l=w.value)==null?void 0:l.name)||a.__("Untitled")),1)]}),_:1},8,["text"]),u("div",fa,[t(oe)?(m(),g(t(z),{key:0,text:a.__("Make a call")},{default:r(()=>[o(n,{class:"h-7 w-7",onClick:he},{default:r(()=>[o(P,{class:"h-4 w-4"})]),_:1})]),_:1},8,["text"])):_("",!0),o(t(z),{text:a.__("Send an email")},{default:r(()=>[o(n,{class:"h-7 w-7"},{default:r(()=>[o(O,{class:"h-4 w-4",onClick:e[6]||(e[6]=l=>t(s).data.email?ke():t(M)(a.__("No email set")))})]),_:1})]),_:1},8,["text"]),o(t(z),{text:a.__("Go to website")},{default:r(()=>[o(n,{class:"h-7 w-7"},{default:r(()=>[o(ze,{class:"h-4 w-4",onClick:e[7]||(e[7]=l=>t(s).data.website?t(Ze)(t(s).data.website):t(M)(a.__("No website set")))})]),_:1})]),_:1},8,["text"])])])]),t(s).data.sla_status?(m(),g(Se,{key:0,modelValue:t(s).data,"onUpdate:modelValue":e[8]||(e[8]=l=>t(s).data=l),onUpdateField:I},null,8,["modelValue"])):_("",!0),t(E).data?(m(),p("div",ga,[u("div",va,[(m(!0),p(W,null,ae(t(E).data,(l,k)=>(m(),p("div",{key:l.label,class:B(["flex flex-col p-3",{"border-b":k!==t(E).data.length-1}])},[o(Z,{"is-opened":l.opened,label:l.label},{actions:r(()=>[l.contacts?(m(),p("div",ya,[o(Ke,{value:"",doctype:"Contact",onChange:e[9]||(e[9]=v=>H(v)),onCreate:(v,V)=>{G.value={first_name:v,company_name:t(s).data.organization},F.value=!0,V()}},{target:r(({togglePopover:v})=>[o(n,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:V=>v()},null,8,["onClick"])]),_:1},8,["onCreate"])])):(!l.contacts&&k==1||k==0)&&t(ce)()?(m(),g(n,{key:1,variant:"ghost",class:"w-7 mr-2",onClick:e[10]||(e[10]=v=>U.value=!0)},{default:r(()=>[o(Ee,{class:"h-4 w-4"})]),_:1})):_("",!0)]),default:r(()=>{var v,V,J;return[l.fields?(m(),g(Ue,{key:0,fields:l.fields,modelValue:t(s).data,"onUpdate:modelValue":e[11]||(e[11]=c=>t(s).data=c),onUpdate:I},null,8,["fields","modelValue"])):(m(),p("div",ba,[(v=t(h))!=null&&v.loading&&((J=(V=t(h))==null?void 0:V.data)==null?void 0:J.length)==0?(m(),p("div",xa,[o(Ae,{class:"h-4 w-4"}),u("span",null,x(a.__("Loading...")),1)])):l.contacts.length?(m(!0),p(W,{key:1},ae(l.contacts,(c,Q)=>(m(),p("div",{key:c.name},[u("div",{class:B(["px-2 pb-2.5",[Q==0?"pt-5":"pt-2.5"]])},[o(Z,{"is-opened":c.opened},{header:r(({opened:we,toggle:X})=>[u("div",ha,[u("div",{class:"flex h-7 items-center gap-2 truncate",onClick:Y=>X()},[o(t(ee),{label:c.full_name,image:c.image,size:"md"},null,8,["label","image"]),u("div",ka,x(c.full_name),1),c.is_primary?(m(),g(C,{key:0,class:"ml-2",variant:"outline",label:a.__("Primary"),theme:"green"},null,8,["label"])):_("",!0)],8,Ca),u("div",wa,[o(t(se),{options:ye(c.name)},{default:r(()=>[o(n,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:2},1032,["options"]),o(n,{variant:"ghost",onClick:Y=>t(D).push({name:"Contact",params:{contactId:c.name}})},{default:r(()=>[o(Le,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),o(n,{variant:"ghost",onClick:Y=>X()},{default:r(()=>[o(d,{name:"chevron-right",class:B(["h-4 w-4 text-gray-900 transition-all duration-300 ease-in-out",{"rotate-90":we}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:r(()=>[u("div",Ia,[u("div",Va,[o(O,{class:"h-4 w-4"}),te(" "+x(c.email),1)]),u("div",za,[o(P,{class:"h-4 w-4"}),te(" "+x(c.mobile_no),1)])])]),_:2},1032,["is-opened"])],2),Q!=l.contacts.length-1?(m(),p("div",$a)):_("",!0)]))),128)):(m(),p("div",Da,x(a.__("No contacts added")),1))]))]}),_:2},1032,["is-opened","label"])],2))),128))])])):_("",!0)]}),_:1})])):_("",!0),o(je,{modelValue:T.value,"onUpdate:modelValue":e[12]||(e[12]=i=>T.value=i),organization:L.value,"onUpdate:organization":e[13]||(e[13]=i=>L.value=i),options:{redirect:!1,afterInsert:i=>I("organization",i.name,()=>{t(re).reload()})}},null,8,["modelValue","organization","options"]),o(He,{modelValue:F.value,"onUpdate:modelValue":e[14]||(e[14]=i=>F.value=i),contact:G.value,options:{redirect:!1,afterInsert:i=>H(i.name)}},null,8,["modelValue","contact","options"]),S.value?(m(),g(qe,{key:2,modelValue:S.value,"onUpdate:modelValue":e[15]||(e[15]=i=>S.value=i),assignees:t(s).data._assignedTo,"onUpdate:assignees":e[16]||(e[16]=i=>t(s).data._assignedTo=i),doc:t(s).data,doctype:"CRM Deal"},null,8,["modelValue","assignees","doc"])):_("",!0),U.value?(m(),g(Ve,{key:3,modelValue:U.value,"onUpdate:modelValue":e[17]||(e[17]=i=>U.value=i),doctype:"CRM Deal"},null,8,["modelValue"])):_("",!0)],64)}}};export{ft as default};
//# sourceMappingURL=Deal-a99ed4b0.js.map
