import{D as ge}from"./DetailsIcon-e1b98c12.js";import{A as ve,S as ye,b as he,L as xe,a as be}from"./SLASection-60be6e93.js";import{E as G}from"./EmailIcon-5d882006.js";import{C as Ce}from"./CommentIcon-8a1c544e.js";import{P as H}from"./PhoneIcon-2b0b9034.js";import{T as Ie}from"./TaskIcon-ba34b83b.js";import{N as ke}from"./NoteModal-67a2219e.js";import{W as we}from"./WhatsAppIcon-a922c570.js";import{I as De}from"./IndicatorIcon-8bdc1dd8.js";import{A as Ve}from"./ArrowUpRightIcon-4de3e6ce.js";import{S as ze}from"./Fields-bccd83f4.js";import{_ as Ae,a as Se}from"./LayoutHeader-f400e0a9.js";import{_ as Ue}from"./OrganizationModal-7c7ff91b.js";import{_ as $e}from"./AssignmentModal-b9aa1b53.js";import{s as Ee,_ as Me}from"./statuses-c18f787a.js";import{C as Be}from"./ContactModal-7ee44134.js";import{_ as Re}from"./Link-b1fdcf99.js";import{_ as K}from"./Section-e7f6a7fa.js";import{_ as Te}from"./CustomActions-dd6491ed.js";import{c as Ne,e as Fe,g as y}from"./index-23e032df.js";import{g as Le,b as Oe}from"./global-005ed632.js";import{o as Pe}from"./organizations-345b05ec.js";import{i as je,c as qe,w as We}from"./settings-5e848745.js";import{v as Ge,x as S,a as He,k as h,i as R,r as T,b as l,c as m,u as t,g as v,w as c,l as f,G as Ke,e as u,d as n,F as N,I as k,n as U,f as J,t as w,H as Q,K as Je,B as Qe}from"./index-9a3d44ca.js";import{D as X}from"./Dropdown-d1bc143c.js";import{_ as Xe}from"./Tabs-9ce471e9.js";import"./FadedScrollableDiv-3ad27946.js";import"./FileUploader-e02978ad.js";import"./DurationIcon-31a1b254.js";import"./CalendarIcon-e7721136.js";import"./LeadsIcon-6f6c2324.js";import"./DealsIcon-3bb51480.js";import"./EmailTemplateModal-8f279830.js";import"./TaskModal-74495bbe.js";import"./contacts-111adff3.js";import"./NestedPopover-767b5999.js";import"./EditIcon-5c615a04.js";import"./OrganizationsIcon-f5eb7efc.js";const Ye={class:"relative flex h-12 items-center justify-between gap-2 py-2.5 pl-5"},Ze={class:"absolute right-0"},ea={key:1,class:"flex h-12 items-center justify-between gap-2 border-b px-3 py-2.5"},aa={class:"flex items-center gap-2"},ta={key:2,class:"flex h-full overflow-hidden"},oa={key:0},sa={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},na={class:"flex flex-col overflow-y-auto"},la={key:0,class:"pr-2"},ia={key:1},ra={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-gray-500"},da={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-gray-700"},ma=["onClick"],ca={class:"truncate"},ua={class:"flex items-center"},pa={class:"flex flex-col gap-1.5 text-base text-gray-800"},_a={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},fa={class:"flex items-center gap-3 p-1 py-1.5"},ga={key:0,class:"mx-2 h-px border-t border-gray-200"},va={key:2,class:"flex h-20 items-center justify-center text-base text-gray-600"},ot={__name:"MobileDeal",props:{dealId:{type:String,required:!0}},setup(Y){const{$dialog:Z,makeCall:ya}=Le(),{organizations:ee,getOrganization:ae}=Pe(),{statusOptions:te,getDealStatus:oe}=Ee(),D=Ge(),_=Y,o=S({url:"crm.fcrm.doctype.crm_deal.api.get_deal",params:{name:_.dealId},cache:["deal",_.dealId],onSuccess:a=>{Ne(a),Fe(a,{doc:a,$dialog:Z,router:D,updateField:C,createToast:y,deleteDoc:pe,call:k})}});He(()=>{o.data||o.fetch()});const $=h(!1),E=h(!1),V=h(!1),M=h({}),se=R(()=>{var a;return((a=o.data)==null?void 0:a.organization)&&ae(o.data.organization)});function ne(a,e,r){e=Array.isArray(a)?"":e,!le(a,e)&&S({url:"frappe.client.set_value",params:{doctype:"CRM Deal",name:_.dealId,fieldname:a,value:e},auto:!0,onSuccess:()=>{o.reload(),$.value=!0,y({title:__("Deal updated"),icon:"check",iconClasses:"text-green-600"}),r==null||r()},onError:s=>{var x;y({title:__("Error updating deal"),text:__((x=s.messages)==null?void 0:x[0]),icon:"x",iconClasses:"text-red-600"})}})}function le(a,e){var s;let r=o.data.fields_meta||{};return(s=r[a])!=null&&s.reqd&&!e?(y({title:__("Error Updating Deal"),text:__("{0} is a required field",[r[a].label]),icon:"x",iconClasses:"text-red-600"}),!0):!1}const ie=R(()=>{var e;let a=[{label:__("Deals"),route:{name:"Deals"}}];return a.push({label:((e=se.value)==null?void 0:e.name)||__("Untitled"),route:{name:"Deal",params:{dealId:o.data.name}}}),a}),z=h(0),re=R(()=>[{name:"Details",label:__("Details"),icon:ge,condition:()=>je.value},{name:"Activity",label:__("Activity"),icon:ve},{name:"Emails",label:__("Emails"),icon:G},{name:"Comments",label:__("Comments"),icon:Ce},{name:"Calls",label:__("Calls"),icon:H,condition:()=>qe.value},{name:"Tasks",label:__("Tasks"),icon:Ie},{name:"Notes",label:__("Notes"),icon:ke},{name:"WhatsApp",label:__("WhatsApp"),icon:we,condition:()=>We.value}].filter(e=>e.condition?e.condition():!0)),A=S({url:"crm.api.doc.get_sidebar_fields",cache:["fieldsLayout",_.dealId],params:{doctype:"CRM Deal",name:_.dealId},auto:!0,transform:a=>de(a)});function de(a){return a.forEach(e=>{e.name!="contacts_section"&&e.fields.forEach(r=>{r.name=="organization"&&(r.create=(s,x)=>{M.value.organization_name=s,E.value=!0,x()},r.link=s=>D.push({name:"Organization",params:{organizationId:s}}))})}),a}const B=h(!1),F=h({});function me(a){let e=[{label:__("Delete"),icon:"trash-2",onClick:()=>ce(a)}];return a.is_primary||e.push({label:__("Set as Primary Contact"),icon:Qe(ze,{class:"h-4 w-4"}),onClick:()=>ue(a)}),e}async function L(a){await k("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:_.dealId,contact:a})&&(b.reload(),y({title:__("Contact added"),icon:"check",iconClasses:"text-green-600"}))}async function ce(a){await k("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:_.dealId,contact:a})&&(b.reload(),y({title:__("Contact removed"),icon:"check",iconClasses:"text-green-600"}))}async function ue(a){await k("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:_.dealId,contact:a})&&(b.reload(),y({title:__("Primary contact set"),icon:"check",iconClasses:"text-green-600"}))}const b=S({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:_.dealId},cache:["deal_contacts",_.dealId],auto:!0,onSuccess:a=>{var r;let e=(r=A.data)==null?void 0:r.find(s=>s.name=="contacts_section");e&&(e.contacts=a.map(s=>({name:s.name,full_name:s.full_name,email:s.email,mobile_no:s.mobile_no,image:s.image,is_primary:s.is_primary,opened:!1})))}});function C(a,e,r){ne(a,e,()=>{o.data[a]=e,r==null||r()})}async function pe(a){await k("frappe.client.delete",{doctype:"CRM Deal",name:a}),D.push({name:"Deals"})}return(a,e)=>{var O;const r=T("FeatherIcon"),s=T("Button"),x=T("Badge");return l(),m(N,null,[t(o).data?(l(),v(Ae,{key:0},{default:c(()=>[u("header",Ye,[n(t(Se),{items:ie.value},null,8,["items"]),u("div",Ze,[n(t(X),{options:t(te)("deal",C)},{default:c(({open:i})=>[n(s,{label:t(o).data.status,class:U(t(oe)(t(o).data.status).colorClass)},{prefix:c(()=>[n(De)]),suffix:c(()=>[n(r,{name:i?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label","class"])]),_:1},8,["options"])])])]),_:1})):f("",!0),t(o).data?(l(),m("div",ea,[(l(),v(Ke(((O=t(o).data._assignedTo)==null?void 0:O.length)==1?"Button":"div"),null,{default:c(()=>[n(Me,{avatars:t(o).data._assignedTo,onClick:e[0]||(e[0]=i=>V.value=!0)},null,8,["avatars"])]),_:1})),u("div",aa,[t(o).data._customActions?(l(),v(Te,{key:0,actions:t(o).data._customActions},null,8,["actions"])):f("",!0)])])):f("",!0),t(o).data?(l(),m("div",ta,[n(t(Xe),{modelValue:z.value,"onUpdate:modelValue":e[7]||(e[7]=i=>z.value=i),tabs:re.value,tablistClass:"!px-3",class:"overflow-auto"},{default:c(({tab:i})=>[i.name=="Details"?(l(),m("div",oa,[t(o).data.sla_status?(l(),v(ye,{key:0,modelValue:t(o).data,"onUpdate:modelValue":e[1]||(e[1]=d=>t(o).data=d),onUpdateField:C},null,8,["modelValue"])):f("",!0),t(A).data?(l(),m("div",sa,[u("div",na,[(l(!0),m(N,null,J(t(A).data,(d,_e)=>(l(),m("div",{key:d.label,class:U(["flex flex-col px-2 py-3 sm:p-3",{"border-b":_e!==t(A).data.length-1}])},[n(K,{"is-opened":d.opened,label:d.label},{actions:c(()=>[d.contacts?(l(),m("div",la,[n(Re,{value:"",doctype:"Contact",onChange:e[2]||(e[2]=g=>L(g)),onCreate:(g,I)=>{F.value={first_name:g,company_name:t(o).data.organization},B.value=!0,I()}},{target:c(({togglePopover:g})=>[n(s,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:I=>g()},null,8,["onClick"])]),_:1},8,["onCreate"])])):f("",!0)]),default:c(()=>{var g,I,P;return[d.fields?(l(),v(he,{key:0,fields:d.fields,modelValue:t(o).data,"onUpdate:modelValue":e[3]||(e[3]=p=>t(o).data=p),onUpdate:C},null,8,["fields","modelValue"])):(l(),m("div",ia,[(g=t(b))!=null&&g.loading&&((P=(I=t(b))==null?void 0:I.data)==null?void 0:P.length)==0?(l(),m("div",ra,[n(xe,{class:"h-4 w-4"}),u("span",null,w(a.__("Loading...")),1)])):d.contacts.length?(l(!0),m(N,{key:1},J(d.contacts,(p,j)=>(l(),m("div",{key:p.name},[u("div",{class:U(["px-2 pb-2.5",[j==0?"pt-5":"pt-2.5"]])},[n(K,{"is-opened":p.opened},{header:c(({opened:fe,toggle:q})=>[u("div",da,[u("div",{class:"flex h-7 items-center gap-2 truncate",onClick:W=>q()},[n(t(Oe),{label:p.full_name,image:p.image,size:"md"},null,8,["label","image"]),u("div",ca,w(p.full_name),1),p.is_primary?(l(),v(x,{key:0,class:"ml-2",variant:"outline",label:a.__("Primary"),theme:"green"},null,8,["label"])):f("",!0)],8,ma),u("div",ua,[n(t(X),{options:me(p.name)},{default:c(()=>[n(s,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:2},1032,["options"]),n(s,{variant:"ghost",onClick:W=>t(D).push({name:"Contact",params:{contactId:p.name}})},{default:c(()=>[n(Ve,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),n(s,{variant:"ghost",onClick:W=>q()},{default:c(()=>[n(r,{name:"chevron-right",class:U(["h-4 w-4 text-gray-900 transition-all duration-300 ease-in-out",{"rotate-90":fe}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:c(()=>[u("div",pa,[u("div",_a,[n(G,{class:"h-4 w-4"}),Q(" "+w(p.email),1)]),u("div",fa,[n(H,{class:"h-4 w-4"}),Q(" "+w(p.mobile_no),1)])])]),_:2},1032,["is-opened"])],2),j!=d.contacts.length-1?(l(),m("div",ga)):f("",!0)]))),128)):(l(),m("div",va,w(a.__("No contacts added")),1))]))]}),_:2},1032,["is-opened","label"])],2))),128))])])):f("",!0)])):(l(),v(be,{key:1,doctype:"CRM Deal",title:i.name,reload:$.value,"onUpdate:reload":e[4]||(e[4]=d=>$.value=d),tabIndex:z.value,"onUpdate:tabIndex":e[5]||(e[5]=d=>z.value=d),modelValue:t(o),"onUpdate:modelValue":e[6]||(e[6]=d=>Je(o)?o.value=d:null)},null,8,["title","reload","tabIndex","modelValue"]))]),_:1},8,["modelValue","tabs"])])):f("",!0),n(Ue,{modelValue:E.value,"onUpdate:modelValue":e[8]||(e[8]=i=>E.value=i),organization:M.value,"onUpdate:organization":e[9]||(e[9]=i=>M.value=i),options:{redirect:!1,afterInsert:i=>C("organization",i.name,()=>{t(ee).reload()})}},null,8,["modelValue","organization","options"]),n(Be,{modelValue:B.value,"onUpdate:modelValue":e[10]||(e[10]=i=>B.value=i),contact:F.value,options:{redirect:!1,afterInsert:i=>L(i.name)}},null,8,["modelValue","contact","options"]),V.value?(l(),v($e,{key:3,modelValue:V.value,"onUpdate:modelValue":e[11]||(e[11]=i=>V.value=i),assignees:t(o).data._assignedTo,"onUpdate:assignees":e[12]||(e[12]=i=>t(o).data._assignedTo=i),doc:t(o).data,doctype:"CRM Deal"},null,8,["modelValue","assignees","doc"])):f("",!0)],64)}}};export{ot as default};
//# sourceMappingURL=MobileDeal-c64a7108.js.map
